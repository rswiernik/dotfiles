#!/bin/zsh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to prompt user for confirmation
prompt_user() {
    local message="$1"
    echo -e "${YELLOW}${message}${NC}"
    read -q "REPLY?Continue? (y/n) "
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Operation cancelled by user.${NC}"
        exit 1
    fi
}

# Detect system architecture
detect_architecture() {
    local os=$(uname -s | tr '[:upper:]' '[:lower:]')
    local arch=$(uname -m)

    # Convert architecture names to terraform's naming
    case "$arch" in
        x86_64)
            arch="amd64"
            ;;
        aarch64|arm64)
            arch="arm64"
            ;;
        *)
            echo -e "${RED}Unsupported architecture: $arch${NC}"
            exit 1
            ;;
    esac

    echo "${os}_${arch}"
}

# Get the latest terraform version
get_latest_version() {
    # Fetch the releases page and extract the latest version number
    # Filter out non-mainline releases (alpha, beta, rc, etc.) before extracting version
    local latest_version=$(curl -s https://releases.hashicorp.com/terraform/ | \
        grep 'terraform_[0-9]' | \
        grep -v '\-alpha\|\-beta\|\-rc' | \
        grep -o 'terraform_[0-9]\+\.[0-9]\+\.[0-9]\+' | \
        head -1 | \
        sed 's/terraform_//')

    if [[ -z "$latest_version" ]]; then
        echo -e "${RED}Failed to fetch latest version${NC}" >&2
        exit 1
    fi

    echo "$latest_version"
}

# Check if version is already installed
is_version_installed() {
    local version="$1"
    local target_path="/usr/local/bin/terraform-${version}"

    if [[ -f "$target_path" ]]; then
        return 0  # true
    else
        return 1  # false
    fi
}

# Main installation process
main() {
    echo -e "${GREEN}=== Terraform Installation Script ===${NC}\n"

    # Detect architecture
    local platform=$(detect_architecture)
    echo -e "${GREEN}Detected platform: ${platform}${NC}\n"

    # Get latest version
    echo -e "${GREEN}Querying for latest Terraform version...${NC}"
    local latest_version=$(get_latest_version)
    echo -e "${GREEN}Latest Terraform version: ${latest_version}${NC}\n"

    # Check if already installed
    if is_version_installed "$latest_version"; then
        echo -e "${YELLOW}Terraform version ${latest_version} is already installed at /usr/local/bin/terraform-${latest_version}${NC}"
        prompt_user "Do you want to reinstall and update the symlink?"
    fi

    # Construct download URL
    local download_url="https://releases.hashicorp.com/terraform/${latest_version}/terraform_${latest_version}_${platform}.zip"
    echo -e "${GREEN}Download URL: ${download_url}${NC}\n"

    # Prompt before downloading
    prompt_user "About to download Terraform ${latest_version}"

    # Create temporary directory
    local temp_dir=$(mktemp -d)
    echo -e "${GREEN}Using temporary directory: ${temp_dir}${NC}"

    # Download the zip file
    echo -e "${GREEN}Downloading Terraform ${latest_version}...${NC}"
    if ! curl -L -o "${temp_dir}/terraform.zip" "$download_url"; then
        echo -e "${RED}Download failed${NC}"
        rm -rf "$temp_dir"
        exit 1
    fi

    # Prompt before unpacking
    prompt_user "About to unpack the downloaded archive"

    # Unpack the zip file
    echo -e "${GREEN}Unpacking...${NC}"
    if ! unzip -q "${temp_dir}/terraform.zip" -d "$temp_dir"; then
        echo -e "${RED}Failed to unpack archive${NC}"
        rm -rf "$temp_dir"
        exit 1
    fi

    # Verify the binary exists
    if [[ ! -f "${temp_dir}/terraform" ]]; then
        echo -e "${RED}Terraform binary not found in archive${NC}"
        rm -rf "$temp_dir"
        exit 1
    fi

    # Prompt before copying to /usr/local/bin
    prompt_user "About to copy terraform binary to /usr/local/bin/terraform-${latest_version} (may require sudo)"

    # Copy the binary to /usr/local/bin with version name
    local target_path="/usr/local/bin/terraform-${latest_version}"
    echo -e "${GREEN}Copying binary to ${target_path}...${NC}"
    sudo cp "${temp_dir}/terraform" "$target_path"
    sudo chmod +x "$target_path"

    # Prompt before creating/updating symlink
    prompt_user "About to create/update symlink from /usr/local/bin/terraform to terraform-${latest_version}"

    # Create or update the symlink
    echo -e "${GREEN}Creating symlink...${NC}"
    sudo rm -f /usr/local/bin/terraform
    sudo ln -s "$target_path" /usr/local/bin/terraform

    # Clean up
    echo -e "${GREEN}Cleaning up temporary files...${NC}"
    rm -rf "$temp_dir"

    # Verify installation
    echo -e "\n${GREEN}=== Installation Complete ===${NC}"
    echo -e "${GREEN}Terraform version:${NC}"
    /usr/local/bin/terraform version
    echo -e "\n${GREEN}Symlink:${NC}"
    ls -la /usr/local/bin/terraform
}

# Run the main function
main
